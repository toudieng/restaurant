{% extends 'authentification/connexion.html' %}

{% block title %}
  <title>Statut des Commandes</title>
{% endblock %}

{% block style %}
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<style>
  table th, table td {
    border: 1px solid #dee2e6;
    vertical-align: middle;
  }
  .btn-sm {
    margin: 2px;
  }

  body {
            padding-top: 70px;
       }

        .alert-danger {
            animation: shake 0.4s ease-in-out;
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        .logo-img {
            height: 100px;
            width: 100px;
            
        }
</style>
{% endblock %}

{% block body %}
<nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="{% url 'accueil' %}">
              <img src="/media/images/2.png" alt="Logo" class="logo-img">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'accueil' %}">Accueil</a>
                    </li>
                    {% if user.is_authenticated %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'logout' %}">Déconnexion</a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

<section class="container py-5 mt-5">
  <h2 class="text-center mb-4">Commandes à Préparer</h2>

  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead class="thead-dark">
        <tr>
          <th scope="col">ID</th>
          <th scope="col">Client</th>
          <th scope="col">Adresse</th>
          <th scope="col">Date</th>
          <th scope="col">Statut</th>
          <th scope="col">Total</th>
          <th scope="col">Plats</th>
          <th scope="col">Image</th>
          <th scope="col">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for commande in commandes %}
          {% if commande.statut == 'en_attente' or commande.statut == 'en_cours' %}
          <tr>
            <td>{{ commande.id }}</td>
            <td>{{ commande.client.username }}</td>
            <td>{{ commande.adresse_livraison }}</td>
            <td>{{ commande.date_commande|date:"d M Y H:i" }}</td>
            <td>
              <span class="badge 
                {% if commande.statut == 'en_attente' %}badge-warning
                {% elif commande.statut == 'en_cours' %}badge-info
                {% elif commande.statut == 'prete' %}badge-success
                {% endif %}">
                {{ commande.get_statut_display }}
              </span>
            </td>
            <td>{{ commande.total_paiement }} FCFA</td>
            <td>
              <ul class="list-unstyled">
                {% for ligne in commande.lignes.all %}
                  <li>{{ ligne.quantite }} x {{ ligne.plat.nom }} ({{ ligne.prix_unitaire }} FCFA/unité)</li>
                {% empty %}
                  <li>Aucun plat</li>
                {% endfor %}
              </ul>
            </td>
            <td>
              <ul class="list-unstyled">
                {% for ligne in commande.lignes.all %}
                  {% if ligne.plat.image %}
                    <li><img src="{{ ligne.plat.image.url }}" alt="{{ ligne.plat.nom }}" style="width: 80px;" class="img-thumbnail"></li>
                  {% else %}
                    <li><em>Pas d'image</em></li>
                  {% endif %}
                {% empty %}
                  <li><em>Pas de plat</em></li>
                {% endfor %}
              </ul>
            </td>
            <td>
              {% if commande.statut == 'en_attente' %}
              <form method="post" action="{% url 'changer_statut_commande' commande.id %}">
                {% csrf_token %}
                <input type="hidden" name="statut" value="en_cours">
                <button type="submit" class="btn btn-sm btn-info">Préparer</button>
              </form>
              {% elif commande.statut == 'en_cours' %}
              <form method="post" action="{% url 'changer_statut_commande' commande.id %}">
                {% csrf_token %}
                <input type="hidden" name="statut" value="prete">
                <button type="submit" class="btn btn-sm btn-success">Prête</button>
              </form>
              {% elif commande.statut == 'prete' %}
              <span class="text-success font-weight-bold">Commande terminée</span>
              {% endif %}
            </td>
          </tr>
          {% endif %}
        {% empty %}
          <tr>
            <td colspan="9" class="text-center">Aucune commande à préparer pour le moment.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endblock %}
