{% extends 'client/base.html' %}
{% load static %}
{% load restaurant_app_extras %}

{% block title %}Votre panier{% endblock %}

{% block content %}
<main class="container mt-5 pt-5">
    <div class="card mt-4 shadow-sm">
        <div class="card-body">
            <h5 class="card-title">Informations de commande et de paiement</h5>
            <form action="{% url 'valider_commande' %}" method="post">
                {% csrf_token %}
                
                <div class="mb-3">
                    <label class="form-label">Mode de commande</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="mode_commande" id="service_en_salle" value="salle" checked>
                        <label class="form-check-label" for="service_en_salle">
                            Service en salle
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="mode_commande" id="livraison" value="livraison">
                        <label class="form-check-label" for="livraison">
                            Livraison à domicile
                        </label>
                    </div>
                </div>

                <div id="section_salle">
                    <div class="mb-3">
                        <label for="reservation_id" class="form-label">Sélectionnez une réservation</label>
                        <select class="form-select" id="reservation_id" name="reservation_id" required>
                            {% if réservations %}
                                {% for res in réservations %}
                                    <option value="{{ res.id }}">Réservation du {{ res.date_réservation }} à {{ res.heure_réservation }} pour {{ res.nombre_personnes }} personnes</option>
                                {% endfor %}
                            {% else %}
                                <option value="" disabled selected>Vous n'avez pas de réservation active.</option>
                            {% endif %}
                        </select>
                    </div>
                </div>

                <div id="section_livraison" style="display: none;">
                    <div class="mb-3">
                        <label for="adresse_input" class="form-label">Adresse de livraison</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="adresse_option" id="saisie_manuelle" value="saisie" checked>
                            <label class="form-check-label" for="saisie_manuelle">
                                Saisie manuelle
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="adresse_option" id="choix_sur_carte" value="carte">
                            <label class="form-check-label" for="choix_sur_carte">
                                Choisir sur la carte
                            </label>
                        </div>
                    </div>
                    <div class="mb-3" id="adresse_manuelle">
                        <input type="text" class="form-control" id="adresse_input" name="adresse_input">
                    </div>
                    <div class="mb-3" id="carte_map" style="height: 300px; display: none;">
                        <div id="mapid" style="height: 100%;"></div>
                        <input type="hidden" id="coordonnees_livraison" name="coordonnees_livraison">
                    </div>
                </div>

                <div class="mb-3">
                    <label for="telephone" class="form-label">Numéro de téléphone</label>
                    <input type="tel" class="form-control" id="telephone" name="telephone" required>
                </div>
                
                <div class="mb-3">
                    <label for="methode_paiement" class="form-label">Méthode de paiement</label>
                    <select class="form-select" id="methode_paiement" name="methode_paiement" required>
                        <option value="">Sélectionner une méthode</option>
                        <option value="wave">Wave</option>
                        <option value="orange_money">Orange Money</option>
                        <option value="kpay">KPay</option>
                        <option value="carte_bancaire">Carte Bancaire</option>
                        </select>
                </div>
                
                <button type="submit" class="btn btn-success w-100">Procéder au paiement</button>
            </form>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const modeCommandeRadios = document.querySelectorAll('input[name="mode_commande"]');
        const sectionLivraison = document.getElementById('section_livraison');
        const sectionSalle = document.getElementById('section_salle');
        const methodePaiementSelect = document.getElementById('methode_paiement');

        function toggleModeCommande() {
            if (document.getElementById('livraison').checked) {
                sectionLivraison.style.display = 'block';
                sectionSalle.style.display = 'none';
                
                // Masquer l'option espèces
                methodePaiementSelect.innerHTML = `
                    <option value="">Sélectionner une méthode</option>
                    <option value="wave">Wave</option>
                    <option value="orange_money">Orange Money</option>
                    <option value="kpay">KPay</option>
                    <option value="carte_bancaire">Carte Bancaire</option>
                `;
            } else { // Service en salle
                sectionLivraison.style.display = 'none';
                sectionSalle.style.display = 'block';
                
                // Afficher l'option espèces
                methodePaiementSelect.innerHTML = `
                    <option value="">Sélectionner une méthode</option>
                    <option value="especes">Espèces (à la caisse)</option>
                    <option value="wave">Wave</option>
                    <option value="orange_money">Orange Money</option>
                    <option value="kpay">KPay</option>
                    <option value="carte_bancaire">Carte Bancaire</option>
                `;
            }
        }
        
        modeCommandeRadios.forEach(radio => radio.addEventListener('change', toggleModeCommande));
        toggleModeCommande(); // Appel initial au chargement de la page
    });
</script>
{% endblock %}