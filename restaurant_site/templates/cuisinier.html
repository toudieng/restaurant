{% extends 'client/base.html' %}

{% block title %}
    <title>Gestion des Commandes - Cuisinier</title>
{% endblock %}

{% block style %}
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<style>
    table th, table td {
        border: 1px solid #dee2e6;
        vertical-align: middle;
        padding: 8px;
    }
    .btn-sm {
        margin: 2px;
    }
    .img-thumbnail {
    max-width: 80px !important;
    max-height: 80px !important;
    width: auto !important;
    height: auto !important;
    object-fit: cover !important;
    display: block !important;
    margin-bottom: 5px !important;
    } 
    .image-list {
        padding-left: 0;
        list-style: none;
        margin-bottom: 0;
    }
    .image-list li {
        margin-bottom: 5px; 
    }
    .image-list li:last-child {
        margin-bottom: 0; 
    }
</style>
{% endblock %}

{% block content %}
<section class="container py-5 mt-5">
    <h2 class="text-center mb-4">Commandes à Préparer</h2>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="thead-dark">
                <tr>
                    <th>Identifiant</th>
                    <th>Statut</th>
                    <th>Plats</th>
                    <th>Images</th>
                </tr>
            </thead>
            <tbody>
                {% for commande in commandes %}
                    <tr>
                        <td>{{ commande.id }}</td>
                        <td>
                            <span class="badge 
                                {% if commande.statut == 'en_attente' %}badge-warning
                                {% elif commande.statut == 'en_cours' %}badge-info
                                {% elif commande.statut == 'prete' %}badge-success
                                {% elif commande.statut == 'livree' %}badge-primary
                                {% elif commande.statut == 'annulee' %}badge-danger
                                {% endif %}">
                                {{ commande.get_statut_display }}
                            </span>
                            {% if commande.statut != 'prete' and commande.statut != 'livree' and commande.statut != 'annulee' %}
                            <form method="post" action="{% url 'changer_statut_commande' commande.id %}">
                                {% csrf_token %}
                                <button type="submit" name="statut" value="prete" class="btn btn-success btn-sm mt-2">
                                    Marquer comme Prête
                                </button>
                            </form>
                            {% endif %}
                        </td>
                        <td>
                            <ul class="list-unstyled">
                                {% for ligne in commande.lignes.all %}
                                    <li>{{ ligne.quantite }} × {{ ligne.plat.nom }} ({{ ligne.prix_unitaire }} FCFA)</li>
                                {% empty %}
                                    <li><em>Aucun plat</em></li>
                                {% endfor %}
                            </ul>
                        </td>
                        <td>
                            <ul class="image-list">
                                {% for ligne in commande.lignes.all %}
                                    {% if ligne.plat.image %}
                                        <li>
                                            <img src="{{ ligne.plat.image.url }}" alt="{{ ligne.plat.nom }}" class="img-thumbnail" style="max-width: 100px; max-height: 100px;">
                                        </li>
                                    {% else %}
                                        <li><em>Pas d'image</em></li>
                                    {% endif %}
                                {% empty %}
                                    <li><em>Aucun plat</em></li>
                                {% endfor %}
                            </ul>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="4" class="text-center">Aucune commande à préparer.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endblock %}