{% extends 'client/base.html' %}
{% load my_app_filters %}

{% block title %}Détails de la Commande #{{ commande.id }}{% endblock %}

{% block content %}
<main class="container mt-5">
    <h2 class="mb-4">Détails de la Commande #{{ commande.id }}</h2>

    <div class="card mb-4">
        <div class="card-header">
            Informations Générales
        </div>
        <div class="card-body">
            <p><strong>Client :</strong> {{ commande.client.username }}</p>
            <p><strong>Date de commande :</strong> {{ commande.date_commande|date:"d M Y H:i" }}</p>
            <p><strong>Statut :</strong> 
                <span class="badge 
                    {% if commande.statut == 'livree' %}bg-success
                    {% elif commande.statut == 'prete' %}bg-info
                    {% elif commande.statut == 'en_cours' %}bg-primary
                    {% elif commande.statut == 'en_attente' %}bg-warning
                    {% else %}bg-danger
                    {% endif %}
                ">{{ commande.get_statut_display }}</span>
            </p>
            <p><strong>Total :</strong> {{ commande.total_paiement }} F CFA</p>
            <p><strong>Mode de commande :</strong> {{ commande.get_mode_commande_display }}</p>
            <p><strong>Moyen de paiement :</strong> {{ commande.get_moyen_paiement_display }}</p>
            {% if commande.transaction_id %}
                <p><strong>ID de transaction :</strong> {{ commande.transaction_id }}</p>
            {% endif %}

            {% if commande.mode_commande == 'livraison' %}
                <hr>
                <h5>Informations de Livraison</h5>
                {% with commande.adresse_livraison|split:"," as coordonnees %}
                    <p><strong>Adresse de livraison :</strong></p>
                    <p>Latitude : {{ coordonnees.0 }}<br>
                    Longitude : {{ coordonnees.1 }}</p>
                    <p><strong>Téléphone :</strong> {{ commande.telephone }}</p>

                    <div id="mini-map-{{ commande.id }}" style="height: 200px; width: 100%;"></div>
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            const lat = parseFloat("{{ coordonnees.0 }}");
                            const lng = parseFloat("{{ coordonnees.1 }}");
                            if (!isNaN(lat) && !isNaN(lng)) {
                                const miniMap = L.map('mini-map-{{ commande.id }}').setView([lat, lng], 15);
                                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                    attribution: '© OpenStreetMap contributors'
                                }).addTo(miniMap);
                                L.marker([lat, lng]).addTo(miniMap);
                                setTimeout(function () { miniMap.invalidateSize(); }, 100);
                            }
                        });
                    </script>
                {% endwith %}
            {% elif commande.mode_commande == 'salle' and commande.reservation %}
                <hr>
                <h5>Informations de Réservation</h5>
                <p><strong>Date de réservation :</strong> {{ commande.reservation.date_reservation }}</p>
                <p><strong>Heure de réservation :</strong> {{ commande.reservation.heure_reservation }}</p>
                <p><strong>Nombre de personnes :</strong> {{ commande.reservation.nombre_personnes }}</p>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            Articles Commandés
        </div>
        <div class="card-body">
            <ul class="list-unstyled">
            {% for ligne in lignes_details %}
                <li>{{ ligne.quantite }} × {{ ligne.plat.nom }} = {{ ligne.sous_total|floatformat:0 }} FCFA</li>
            {% endfor %}
            </ul>
        </div>
    </div>

    <a href="{% url 'mes_commandes' %}" class="btn btn-secondary mt-3">Retour à mes commandes</a>
</main>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
{% endblock %}
